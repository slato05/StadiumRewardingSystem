<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/bootstrap}">
<head>
    <meta charset="UTF-8">
    <title>Stadium Rewards Preference Summary</title>
</head>

<body>
<div layout:fragment="content">
    <h3 class="text-center mb-4 fw-bold text-primary">Preference Summary</h3>

    <div class="table-responsive mb-5">
        <table class="table table-striped table-bordered table-hover text-center align-middle">
            <thead class="table-dark">
            <tr>
                <th>Stand</th>
                <th>Available Seats</th>
                <th>Number of Preferred Seats</th>
                <th>Discount Price</th>
                <th>Estimated Total Earnings</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="s : ${summaries}">
                <td th:text="${s.standName}"></td>
                <td th:text="${s.availableSeats}"></td>
                <td th:text="${s.numberOfPreferredSeats}"></td>
                <td th:text="${s.discountPrice}"></td>
                <td th:text="${s.estimatedTotalEarnings}"></td>
            </tr>
            </tbody>
        </table>
    </div>

    <hr>
    <h3 class="mb-3 text-success">Preference Gathering</h3>

    <form id="preferenceForm" class="mb-3">
        <div class="row">
            <div class="col-md-6">
                <label class="form-label">First Name:</label>
                <input type="text" id="firstName" class="form-control" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">Last Name:</label>
                <input type="text" id="lastName" class="form-control" required>
            </div>
        </div>

        <div class="row mt-2">
            <div class="col-md-6">
                <label class="form-label">Email:</label>
                <input type="email" id="email" class="form-control" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">Phone:</label>
                <input type="text" id="phone" class="form-control">
            </div>
        </div>

        <div class="row mt-2">
            <div class="col-md-6">
                <label class="form-label">Occupation:</label>
                <select id="occupation" class="form-select">
                    <option value="STU">Student</option>
                    <option value="EDU">Educator</option>
                    <option value="MLT">Military</option>
                    <option value="OTH">Other</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Preferred Stand:</label>
                <select id="stand" class="form-select">
                    <option value="EAST">East</option>
                    <option value="WEST">West</option>
                    <option value="SOUTH">South</option>
                    <option value="NORTH">North</option>
                </select>
            </div>
        </div>

        <div class="mt-2">
            <label class="form-label">Reservation Time:</label>
            <input type="text" id="reservationTime" class="form-control" placeholder="yyyy-MM-dd HH:mm:ss.SSS">
        </div>

        <div class="mt-3">
            <button type="button" id="addBtn" class="btn btn-outline-success me-2">Add</button>
            <input type="file" id="importFile" style="display:none" accept=".json"/>
            <button type="button" id="importBtn" class="btn btn-outline-danger me-2">Import</button>
            <button type="button" id="importAppendBtn" class="btn btn-outline-warning">Import & Append</button>
        </div>
    </form>
</div>

<!-- Page-specific JS fragment -->
<div layout:fragment="scripts">
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("Preference page script loaded.");

            const addBtn = document.getElementById('addBtn');
            const importBtn = document.getElementById('importBtn');
            const importAppendBtn = document.getElementById('importAppendBtn');
            const importFile = document.getElementById('importFile');

            // ---- ADD BUTTON ----
            if (addBtn) {
                addBtn.onclick = async () => {
                    const firstName = document.getElementById('firstName').value.trim();
                    const lastName = document.getElementById('lastName').value.trim();
                    const email = document.getElementById('email').value.trim();
                    const reservationTime = document.getElementById('reservationTime').value.trim();

                    // Basic client-side validation
                    if (!firstName || !lastName || !email || !reservationTime) {
                        alert("Please fill out all required fields, including reservation time.");
                        return; // stop here
                    }

                    const body = {
                        fan: {
                            firstName,
                            lastName,
                            email,
                            phoneNumber: document.getElementById('phone').value.trim(),
                            occupation: document.getElementById('occupation').value
                        },
                        standId: document.getElementById('stand').value,
                        reservationTime
                    };

                    try {
                        const res = await fetch('/api/preferences/add', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        });
                        const text = await res.text();
                        alert(text);
                        console.log("Server response:", text);
                    } catch (err) {
                        alert('Error sending request: ' + err);
                        console.error(err);
                    }
                };

            }

            // ---- IMPORT BUTTONS ----
            if (importBtn && importAppendBtn && importFile) {
                // Overwrite import (append=false)
                importBtn.onclick = () => {
                    importFile.dataset.append = 'false';
                    importFile.click();
                };

                // Append import (append=true)
                importAppendBtn.onclick = () => {
                    importFile.dataset.append = 'true';
                    importFile.click();
                };

                // Shared file handler
                importFile.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const append = importFile.dataset.append === 'true';
                    const formData = new FormData();
                    formData.append('file', file);

                    const url = '/api/preferences/import?append=' + append;
                    console.log("Uploading file to:", url);

                    try {
                        const res = await fetch(url, { method: 'POST', body: formData });
                        const text = await res.text();
                        if (res.ok) {
                            alert(text);
                            console.log("Import response:", text);
                        } else {
                            alert("Import failed: " + text);
                            console.error("Import error:", text);
                        }
                    } catch (err) {
                        console.error("Import failed:", err);
                        alert("Import failed. See console for details.");
                    }

                    // Reset file input
                    importFile.value = "";
                    delete importFile.dataset.append;
                };
            }
        });
    </script>
</div>
</body>
</html>
