<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/bootstrap}">
<head>
    <meta charset="UTF-8">
    <title>Stadium Rewards Preference Summary</title>
</head>

<body>
<div layout:fragment="content">
    <h3 class="text-center mb-4 fw-bold text-primary">Preference Summary</h3>

    <div class="table-responsive mb-5">
        <table class="table table-striped table-bordered table-hover text-center align-middle">
            <thead class="table-dark">
            <tr>
                <th>Stand</th>
                <th>Available Seats</th>
                <th>Number of Preferred Seats</th>
                <th>Discount Price</th>
                <th>Estimated Total Earnings</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="s : ${summaries}">
                <td th:text="${s.standName}"></td>
                <td th:text="${s.availableSeats}"></td>
                <td th:text="${s.numberOfPreferredSeats}"></td>
                <td th:text="${s.discountPrice}"></td>
                <td th:text="${s.estimatedTotalEarnings}"></td>
            </tr>
            </tbody>
        </table>
    </div>

    <hr>
    <h3 class="mb-3 text-success">Preference Gathering</h3>

    <form id="preferenceForm" class="mb-3">
        <div class="row">
            <div class="col-md-6">
                <label class="form-label">First Name:</label>
                <input type="text" id="firstName" class="form-control" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">Last Name:</label>
                <input type="text" id="lastName" class="form-control" required>
            </div>
        </div>

        <div class="row mt-2">
            <div class="col-md-6">
                <label class="form-label">Email:</label>
                <input type="email" id="email" class="form-control" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">Phone:</label>
                <input type="text" id="phone" class="form-control">
            </div>
        </div>

        <div class="row mt-2">
            <div class="col-md-6">
                <label class="form-label">Occupation:</label>
                <select id="occupation" class="form-select">
                    <option value="STU">Student</option>
                    <option value="EDU">Educator</option>
                    <option value="MLT">Military</option>
                    <option value="OTH">Other</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Preferred Stand:</label>
                <select id="stand" class="form-select">
                    <option value="EAST">East</option>
                    <option value="WEST">West</option>
                    <option value="SOUTH">South</option>
                    <option value="NORTH">North</option>
                </select>
            </div>
        </div>

        <div class="mt-2">
            <label class="form-label">Reservation Time:</label>
            <input type="text" id="reservationTime" class="form-control" placeholder="yyyy-MM-dd HH:mm:ss.SSS">
        </div>

        <div class="mt-3">
            <button type="button" id="addBtn" class="btn btn-success me-2">Add</button>
            <input type="file" id="importFile" style="display:none" accept=".json"/>
            <button type="button" id="importBtn" class="btn btn-primary">Import</button>
        </div>
    </form>
</div>

<!-- Page-specific JS fragment -->
<div layout:fragment="scripts">
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("Preference page script loaded.");

            const addBtn = document.getElementById('addBtn');
            const importBtn = document.getElementById('importBtn');
            const importFile = document.getElementById('importFile');

            if (addBtn) {
                addBtn.onclick = async () => {
                    console.log("Add button clicked.");

                    const body = {
                        fan: {
                            firstName: document.getElementById('firstName').value,
                            lastName: document.getElementById('lastName').value,
                            email: document.getElementById('email').value,
                            phoneNumber: document.getElementById('phone').value,
                            occupation: document.getElementById('occupation').value
                        },
                        standId: document.getElementById('stand').value,
                        reservationTime: document.getElementById('reservationTime').value
                    };

                    try {
                        const res = await fetch('/api/preferences/add', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        });
                        const text = await res.text();
                        alert(text);
                        console.log("Server response:", text);
                    } catch (err) {
                        alert('Error sending request: ' + err);
                        console.error(err);
                    }
                };
            }

            if (importBtn && importFile) {
                importBtn.onclick = () => importFile.click();

                importFile.onchange = async (e) => {
                    const file = e.target.files[0];
                    const formData = new FormData();
                    formData.append('file', file);

                    try {
                        const res = await fetch('/api/preferences/import', { method: 'POST', body: formData });
                        const text = await res.text();
                        alert(text);
                        console.log("Import response:", text);
                    } catch (err) {
                        console.error("Import failed:", err);
                        alert("Import failed. See console for details.");
                    }

                    importFile.value = "";
                };
            }
        });
    </script>
</div>
</body>
</html>
